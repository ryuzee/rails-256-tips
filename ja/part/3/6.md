## 3.6 クエリ

### 単一のオブジェクトを取り出す

**`find`メソッド**

`find`メソッドは指定した引数と同じプライマリキーを持つオブジェクトを取得します。どのレコードにもマッチしない場合は`ActiveRecord::RecordNotFound`例外が発生します。

```ruby
user = User.find(1)
=> #<User id: 1, email: nil, password: nil, created_at: "2018-06-26 15:52:29", updated_at: "2018-06-26 15:52:29">
```

**`find_by`メソッド**

`find_by`メソッドは指定条件にマッチする最初のオブジェクトを取得します。

```ruby
user = User.find_by(id: 1)
=> #<User id: 1, email: nil, password: nil, created_at: "2018-06-26 15:52:29", updated_at: "2018-06-26 15:52:29">

user = User.find_by(email: 'test@example.com')
=> nil
```

**`first`メソッド**

`first`メソッドはプライマリキー順の最初のオブジェクトを取得します。オブジェクトが存在しない場合は`ActiveRecord::RecordNotFound`例外が発生します。

```ruby
user = User.first
=> #<User id: 1, email: nil, password: nil, created_at: "2018-06-26 15:52:29", updated_at: "2018-06-26 15:52:29">
```

**`last`メソッド**

`last`メソッドはプライマリキー順の最後のオブジェクトを取得します。オブジェクトが存在しない場合は`ActiveRecord::RecordNotFound`例外が発生します。

```ruby
user = User.last
=> #<User id: 1, email: nil, password: nil, created_at: "2018-06-26 15:52:29", updated_at: "2018-06-26 15:52:29">
```

**`take`メソッド**

`take`メソッドはデータベースから無条件にオブジェクトを取得します。オブジェクトが存在しない場合は`ActiveRecord::RecordNotFound`例外が発生します。

```ruby
user = User.take
=> #<User id: 1, email: nil, password: nil, created_at: "2018-06-26 15:52:29", updated_at: "2018-06-26 15:52:29">
```

### 複数のオブジェクトを取り出す

**`find_each`メソッド**

`find_each`メソッドはデータベースからレコードを一つずつ取り出し、ブロックに渡します。
ブロックに渡されたレコードを使って様々な処理をすることができます。

以下の例では、全ユーザーの`email`を出力しています。

```ruby
User.find_each do |user|
  p user.email
end
```

**`find_in_batches`メソッド**

`find_in_batches`メソッドはデータベースからレコードをデフォルトで1000件ずつ取り出し、ブロックに渡します。
ブロックに渡されたレコードの配列を使って様々な処理をすることができます。

以下の例では、全ユーザーの`email`を出力しています。

```ruby
User.find_in_batches do |users|
  export_to_csv(users) # csvに1000件ずつエクスポート
end
```

### 条件を指定して取り出す

**文字列で条件を指定する**

条件を指定するには`where`メソッドを使います。`where`メソッドに条件の文字列を渡すことで検索が可能です。

```Ruby
Post.where("title = 'This is title'")
=> #<ActiveRecord::Relation [#<Post id: 1, title: "This is title", body: nil, created_at: "2018-06-15 15:00:50", updated_at: "2018-06-15 15:00:50", published_at: nil, user_id: nil>, #<Post id: 2, title: "This is title", body: nil, created_at: "2018-06-15 15:00:50", updated_at: "2018-06-15 15:00:50", published_at: nil, user_id: nil>]>
```

**配列で条件を指定する**

`where`メソッドは配列で条件を指定することもできます。この場合条件文内の`?`は`where`メソッドの条件文の後の引数で置き換えられます。

```Ruby
condition = 'This is title'
Post.where("title = ?", condition)
=> #<ActiveRecord::Relation [#<Post id: 1, title: "This is title", body: nil, created_at: "2018-06-15 15:00:50", updated_at: "2018-06-15 15:00:50", published_at: nil, user_id: nil>, #<Post id: 2, title: "This is title", body: nil, created_at: "2018-06-15 15:00:50", updated_at: "2018-06-15 15:00:50", published_at: nil, user_id: nil>]>
```

**ハッシュで条件を指定する**

`where`メソッドはハッシュで条件を指定することもできます。この場合ハッシュのキーはカラム名、値は条件になります。

```Ruby
Post.where(title: 'This is title')
=> #<ActiveRecord::Relation [#<Post id: 1, title: "This is title", body: nil, created_at: "2018-06-15 15:00:50", updated_at: "2018-06-15 15:00:50", published_at: nil, user_id: nil>, #<Post id: 2, title: "This is title", body: nil, created_at: "2018-06-15 15:00:50", updated_at: "2018-06-15 15:00:50", published_at: nil, user_id: nil>]>
```

**NOT条件**

SQLのNOTを表現するには`where.not`を使います。NOTの条件は`not`の引き数に指定します。

```Ruby
Post.where.not(title: '') # タイトルが空ではない
=> #<ActiveRecord::Relation [#<Post id: 1, title: "This is title", body: nil, created_at: "2018-06-15 15:00:50", updated_at: "2018-06-15 15:00:50", published_at: nil, user_id: nil>, #<Post id: 2, title: "This is title", body: nil, created_at: "2018-06-15 15:00:50", updated_at: "2018-06-15 15:00:50", published_at: nil, user_id: nil>, #<Post id: 4, title: "これはタイトルです", body: "これは本文です。", created_at: "2018-06-27 08:36:22", updated_at: "2018-06-27 08:36:22", published_at: nil, user_id: nil>, #<Post id: 5, title: "カテゴリの投稿", body: nil, created_at: "2018-06-27 08:53:18", updated_at: "2018-06-27 08:53:18", published_at: nil, user_id: nil>]>
```

**OR条件**

OR条件を使いたい場合は、１つ目のリレーションでorメソッドを呼び出し、そのメソッドの引数に２つ目のリレーションを渡すことで実現できます。

SQLのORを表現するには`or`メソッドを使います。一つ目の条件のあとで`or`を呼び出し、その引数に二つ目の条件を渡します。

```Ruby
Post.where(title: 'This is title').or(Post.where(title: 'これはタイトルです'))
=> #<ActiveRecord::Relation [#<Post id: 1, title: "This is title", body: nil, created_at: "2018-06-15 15:00:50", updated_at: "2018-06-15 15:00:50", published_at: nil, user_id: nil>, #<Post id: 2, title: "This is title", body: nil, created_at: "2018-06-15 15:00:50", updated_at: "2018-06-15 15:00:50", published_at: nil, user_id: nil>, #<Post id: 4, title: "これはタイトルです", body: "これは本文です。", created_at: "2018-06-27 08:36:22", updated_at: "2018-06-27 08:36:22", published_at: nil, user_id: nil>]>
```

### 並び順を指定して取り出す
### 特定のカラムのみを取り出す
### 件数、範囲を指定して取り出す
### グルーピングして取り出す
### テーブルを結合する
### 結合されたテーブルで条件を指定する
### 関連付けを一括読み込みする
### スコープを使ってクエリを再利用する
### Enumを利用する
### SQL文を利用する
### オブジェクトの存在を確認する
### レコード数をカウントする
### フィールドの平均を計算する
### フィールドの合計を計算する
### フィールドの最大値を取得する
### フィールドの最小値を取得する
